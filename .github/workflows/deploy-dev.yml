name: Backend Dev CD

on:
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: JDK 21 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: gradle

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
        run: chmod +x gradlew

      - name: Gradle ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)
        run: ./gradlew clean build -x test

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: Docker ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ (Multi-platform)
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/backend-app:dev
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: ê°œë°œì„œë²„ ë°°í¬
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: SSHë¡œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            cd /home/${{ secrets.DEV_SERVER_USER }}/app
            
            echo "ðŸš€ ê°œë°œ ì„œë²„ ë°°í¬ ì‹œìž‘..."
            
            echo "ðŸ“¦ ìµœì‹  ì´ë¯¸ì§€ Pull..."
            docker pull ${{ secrets.DOCKER_USERNAME }}/backend-app:dev
            
            echo "ðŸŒ³ .env íŒŒì¼ ìƒì„±..."
            cat > .env <<'EOF'
            ${{ secrets.DEV_ENV_FILE }}
            EOF
            chmod 600 .env
            
            echo "â–¶ï¸ ìƒˆ ì„œë²„ ì‹œìž‘..."
            docker compose --env-file .env pull backend
            docker compose --env-file .env up -d --force-recreate backend
            
            echo "ðŸ§¹ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬..."
            docker image prune -a -f
            
            echo "â›‘ï¸ í—¬ìŠ¤ ì²´í¬..."
            for i in $(seq 1 15); do
              sleep 3
              SERVER_STATUS=$(curl -o /dev/null -s -w "%{http_code}" https://pickledev.duckdns.org/actuator/health || echo "000")
              if [ "$SERVER_STATUS" -eq 200 ]; then
                echo "âœ… ë°°í¬ ì„±ê³µ! ì„œë²„ ë™ìž‘ ì¤‘..."
                exit 0
              else
                echo "Attempt $i/15: í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (status=$SERVER_STATUS). ìž¬ì‹œë„ ì¤‘..."
              fi
            done
            
            echo "âŒ ë°°í¬ ì‹¤íŒ¨! ì„œë²„ê°€ ë™ìž‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            echo "ðŸ“‹ ìµœê·¼ ë¡œê·¸:"
            docker logs pickle-backend-dev --tail 100
            exit 1

      - name: ë°°í¬ ê²°ê³¼ ì•Œë¦¼
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ë°°í¬ ì‹œê°„: $(date)"
            echo "ì»¤ë°‹: ${{ github.sha }}"
          else
            echo "âŒ ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤!"
            echo "GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
          fi
