name: Backend Manual Prod CD

on:
  workflow_dispatch:

jobs:
  build:
    name: Docker ì´ë¯¸ì§€ ë¹Œë“œ
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: JDK 21 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
          cache: gradle

      - name: gradlew ì‹¤í–‰ ê¶Œí•œ ì„¤ì •
        run: chmod +x gradlew

      - name: Gradle ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)
        run: ./gradlew clean build -x test -x docsTest

      - name: Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3

      - name: Docker ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/arm64
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/backend-app:prod
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: ìš´ì˜ ë°°í¬
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: SSHë¡œ ìš´ì˜ ë°°í¬ (Nginx -> Prod)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.NGINX_SERVER_HOST }}
          username: ${{ secrets.NGINX_SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -euo pipefail

            echo "ðŸš€ ìš´ì˜ ë°°í¬ ì‹œìž‘ (Nginx -> Prod)"

            ssh prod "bash -s" <<'PROD_SCRIPT'
            set -euo pipefail
            cd ~/app

            echo "ðŸŒ³ .env ìƒì„±/ê°±ì‹ ..."
            umask 077
            cat > .env <<'EOF'
            ${{ secrets.PROD_ENV_FILE }}
            EOF
            chmod 600 .env

            echo "ðŸ“¦ ìµœì‹  ì´ë¯¸ì§€ Pull..."
            sudo docker compose --env-file .env pull backend

            echo "â–¶ï¸ backend ìž¬ê¸°ë™..."
            sudo docker compose --env-file .env up -d --force-recreate backend

            echo "ðŸ§¹ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬..."
            sudo docker image prune -f
            PROD_SCRIPT

            echo "â›‘ï¸ í—¬ìŠ¤ ì²´í¬..."
            for i in $(seq 1 20); do
              sleep 3
              STATUS=$(curl -o /dev/null -s -w "%{http_code}" \
                --connect-timeout 3 --max-time 5 \
                "${{ secrets.PROD_HEALTHCHECK_URL }}" || echo "000")
              if [[ "$STATUS" == "200" ]]; then
                echo "âœ… ë°°í¬ ì„±ê³µ! (status=$STATUS)"
                exit 0
              fi
              echo "Attempt $i/20: status=$STATUS"
            done

            echo "âŒ ë°°í¬ ì‹¤íŒ¨"
            exit 1
